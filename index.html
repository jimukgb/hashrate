<html>
	<head>
		<title>Bitcoin Hashrate</title>
		<link rel="icon" type="image/x-icon" href="bitcoin.ico">
		<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<script>
			let HOST  = "https://api.blockchair.com/";
			
			let API   = new Intl.DateTimeFormat("fr-ca", {year: "numeric", month: "numeric"});
			let PRINT = new Intl.DateTimeFormat("en", {year: "numeric", month: "short"});
			let YEAR  = new Intl.DateTimeFormat("en", {year: "numeric"});
			let MONTH = new Intl.DateTimeFormat("en", {month: "long"});

			let table, timer;
			
			function prefix(m){return m==0?" ":m==1?"K":m==2?"M":m==3?"G":m==4?"T":m==5?"P":m==6?"E":m==7?"Z":m==8?"Y":m==9?"R":m==10?"Q":"ðŸ¤¯"}
			function magnitude(w){return w?parseInt(Math.floor(Math.log10(parseFloat(w))/3)):0}

			function save()
			{
				if(document.getElementById("chain").disabled)
				{
					alert("Downloading hashrate data from API provider currently in progress...");
					
					return;
				}
				
				let output = "{\n";
				
				output += "\t\"genesis\": {";
				output += "\"time\": " + table["genesis"].time.getTime()/1000 + ", ";
				output += "\"work\": \"" + table["genesis"].work.toString() + "\"},";
								
				for(let year in table)
				{
					if(year == "genesis") continue;
					
					let annum = "";
					
					for(let month in table[year])
					{
						if(year == YEAR.format(new Date()) && month == MONTH.format(new Date())) break;
						if(table[year][month].work == -1n) continue;
						
						annum += "\n\t\t" + ("\"" + month + "\":").padEnd(12, " ") + " {";
						annum += "\"time\": " + table[year][month].time.getTime()/1000 + ", ";
						annum += "\"work\": \"" + table[year][month].work.toString() + "\"},";
					}
					
					if(annum.length)
					{
						output += "\n\t\"" + year + "\":\n\t{";
						output += annum;
						output = output.slice(0, -1) + "\n\t},";
					}
				};
				
				output = output.slice(0, -1) + "\n}";
				
				let link = document.createElement("a");
				
				link.href = URL.createObjectURL(new Blob([output], {type: "application/json"}));
				link.download = localStorage.chain.replaceAll("/", "-") + ".json";
				link.target = "_blank";
				
				link.click();
				URL.revokeObjectURL(link.href);
				link.remove();
			}
			
			function print(scroll = false)
			{
				document.getElementById("page").hidden = false;
				document.getElementById("table").innerHTML = "";
				
				let date = table["genesis"].time, period = new Date("2009-01-10"), work = 0n;
						
				while(period<date)
				{
					if(table[YEAR.format(period)]==undefined) table[YEAR.format(period)] = {};
					table[YEAR.format(period)][MONTH.format(period)] = {time: new Date(period), work: -1n};
					period.setMonth(period.getMonth()+1);
				}
				
				for(let year in table)
				{
					if(year == "genesis") continue;
					
					let output = [];
					
					output.push("<div>");
					output.push("   Date       Hashrate      Work      Chainwork");
					output.push("-----------------------------------------------");
					
					let annum = [];
					
					for(let month in table[year])
					{
						if(table[year][month].work == -1n)
						{
							annum.push("[" + PRINT.format(table[year][month].time) + "]" + "       ---         ---         ---");
							continue;
						}
						
						let totalwork = table[year][month].work;
						let chainwork = (work += totalwork);
						let hashrate  = totalwork/BigInt(Math.round((table[year][month].time - date)/1000+1));
						
						date = table[year][month].time;
						
						chainwork = (parseFloat(chainwork)/1000**magnitude(chainwork)).toFixed(3) + " " + prefix(magnitude(chainwork)) + "H";
						totalwork = (parseFloat(totalwork)/1000**magnitude(totalwork)).toFixed(3) + " " + prefix(magnitude(totalwork)) + "H";
						hashrate  = (parseFloat(hashrate)/1000**magnitude(hashrate)).toFixed(2) + " " + prefix(magnitude(hashrate)) + "H/s";
						
						annum.push("[" + PRINT.format(date) + "]" + hashrate.padStart(13, " ") + totalwork.padStart(12, " ") + chainwork.padStart(12, " "));
					}
					
					annum.sort((a, b)=>new Date(a.substring(1, 9))<new Date(b.substring(1, 9))?-1:1);
					
					output = output.concat(annum);
					
					output.push("</div>");
					
					document.getElementById("table").innerHTML += output.join("<br>").replaceAll(" ", "&nbsp;");
				}
				
				if(scroll)
					window.scrollBy({top: parseInt(sessionStorage.position) + window.innerHeight, behavior: "smooth"});
				else
					window.scrollTo({top: sessionStorage.position?sessionStorage.position:document.body.scrollHeight, behavior: sessionStorage.position?"instant":"smooth"});
			}
			
			function sync(time, work)
			{
				fetch(HOST+localStorage.chain+"/blocks?q=time("+API.format(time)+")&s=id(desc)&limit=1").
				then(response=>response.ok?response.json().then(block =>
				{				
					if(table[YEAR.format(time)]==undefined) table[YEAR.format(time)] = {};
					table[YEAR.format(time)][MONTH.format(time)] =
					{
						time: new Date(block.data.length?block.data[0].time:time),
						work: block.data.length?BigInt("0x" + block.data[0].chainwork) - work:0n
					};
					
					print(window.innerHeight + parseInt(window.scrollY) + 3*parseInt(window.getComputedStyle(document.body).fontSize) >= document.getElementById("page").offsetHeight);
					
					time.setDate(1); time.setMonth(time.getMonth()+1);
					
					if(12*time.getFullYear()+time.getMonth() > 12*new Date().getFullYear()+new Date().getMonth())
					{
						document.getElementById("chain").disabled = false;
						
						time.setMonth(time.getMonth()-1);
						timer = setTimeout(sync, 150000, time, work);
						return;
					}
					
					if(block.data.length) work = BigInt("0x" + block.data[0].chainwork);
					
					timer = setTimeout(sync,  1000, time, work);
				}):timer = setTimeout(sync, 10000, time, work))
			}
			
			function download(start)
			{
				document.getElementById("chain").disabled = true;
				
				fetch(HOST+localStorage.chain+"/blocks?q=id(" + start + ".." + (parseInt(start) + 1) + ")&s=id(asc)").
				then(response=>response.ok?response.json().then(block =>
				{
					table = {genesis: {time: new Date(block.data[1].time), work: BigInt("0x" + block.data[0].chainwork)}};
					
					sync(new Date(table["genesis"].time), table["genesis"].work);
					
				}):timer = setTimeout(download, 10000, start))
			}

			window.onload = function()
			{
				document.getElementById("chain").value = localStorage.chain = (localStorage.chain?localStorage.chain:document.getElementById("chain").value);
				
				window.onkeypress = document.getElementById("page").onmousedown = function()
				{
					document.getElementById("selector").classList.toggle("fade");
				};
			
				(document.getElementById("chain").onchange = function()
				{
					let start, option = Array.from(document.getElementById("chain").children).filter(o => o.value==localStorage.chain)[0];
					
					if(timer) clearTimeout(timer);
					
					document.getElementById("fork").innerText = option.getAttribute("name");
					start = option.getAttribute("data-start");

					document.getElementById("chain").disabled = true;	
					localStorage.chain = document.getElementById("chain").value;
				
					fetch(localStorage.chain.replaceAll("/", "-")+".json").
					then(response=>response.ok?response.text().then(content =>
					{
						table = JSON.parse(content, (key, value) =>
						{
							switch(key)
							{
								case "time": return new Date(value*1000);
								case "work": return BigInt(value);
								default: return value;
							}
						});
						
						let time, work = table["genesis"].work;

						for(year in table)
						{
							if(year == "genesis") continue;
							
							for(month in table[year])
							{
								if(12*table[year][month].time.getFullYear()+table[year][month].time.getMonth() >= 12*new Date().getFullYear()+new Date().getMonth())
								{
									delete table[year][month];
									continue;
								}
							
								time = table[year][month].time;
								work += table[year][month].work;
							}
						}
						
						time = new Date(time);
						time.setDate(1);
						time.setMonth(time.getMonth()+1);
						
						print(); sync(time, work); 
						
					}):download(start));
				})();
			}
			
			window.onscroll = function()
			{
				if(sessionStorage.position) sessionStorage.position = window.scrollY;
			}
			
			window.onscrollend = function()
			{
				if(window.scrollY) sessionStorage.position = window.scrollY;
			}
		</script>
		<style>
			body
			{
				font-family: monospace;
				height: 100%;
				width: 100%;
				margin: 0;
			}
			
			#selector
			{
				opacity: 1;
				transition: opacity 1s;
				position: fixed;
				top: 10px;
				right: 10px;
			}
			
			#selector.fade
			{
				opacity: 0;
				pointer-events: none;
			}
			
			#chain
			{
				font-family: monospace;
				font-size: 34;
				width: auto;
			}
			
			#page
			{
				top: 50%;
				left: 50%;
				width:100%;
				position: absolute;
				transform: translate(max(-50vw, -50%), max(-50vh, -50%));
			}
			
			#heading
			{
				width: 100%;
				text-align: center;
				font-size: 26;
				padding-top: 80px;
				padding-bottom: 10px;
			}
			
			#table
			{
				display: flex;
				flex-direction: row;
				flex-wrap: wrap;
				align-content: center;
				justify-content: space-evenly;
			}
			
			#table > div
			{
				margin: 10px;
			}
		</style>
	</head>
	<body>
		<div id="page" hidden>
			<div id="heading">
				<span id="fork"></span> Mining Network Monthly Hashrate Table
			</div>
			<div id="table"></div>
		</div>
		<div id="selector">
			<select id="chain" disabled>
				<option value="bitcoin" name="Bitcoin" data-start="0">BTC</option>
				<option value="bitcoin-cash" name="Bitcoin Cash" data-start="478558">BCH</option>
				<option value="bitcoin-sv" name="Bitcoin SV" data-start="556766" disabled>BSV</option>
				<option value="ecash" name="eCash" data-start="661647">XEC</option>
				<option value="bitcoin/testnet" name="Testnet" data-start="0">TST</option>
				<option value="litecoin-cash" name="Litecoin Cash" data-start="0" hidden>LCC</option>
				<option value="*" name="SHA256D" hidden>ALL</option>
			</select>
		</div>
	</body>
</html>